name: Continuous Integration 
on: [push] 
jobs: 
 build: 
  name: build
  runs-on: ubuntu-latest 
  steps: 
  - uses: actions/checkout@v2 
  - run: docker build --target test --tag todo-app:test .
  - run: docker run --env-file ./.env.test todo-app:test
 deploy:
  name: deploy
  needs: build
  runs-on: ubuntu-latest
  if: github.event_name == 'push' && github.ref == 'refs/heads/Module8'
  steps:
   - uses: actions/checkout@v2
   - run: docker login -u keithleverton -p ${{secrets.DOCKERPASSWORD}}
   - run: docker build --target production --tag keithleverton/todo-app:$GITHUB_SHA .
   - run: docker push keithleverton/todo-app:$GITHUB_SHA
   - run: curl https://cli-assets.heroku.com/install-ubuntu.sh | sh
   - run: heroku login
   - run: docker tag keithleverton/todo-app:$GITHUB_SHA registry.heroku.com/to-do-app-kl/web
   - run: docker push registry.heroku.com/to-do-app-kl/web
   - run: heroku container:release web -a to-do-app-kl


